<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTFâ€‘8"/>
  <meta name="viewport" content="width=deviceâ€‘width, initialâ€‘scale=1.0"/>
  <title>Quiz Game</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <h1>Quiz Time</h1>
  <div id="game">
    <h2 id="question">Loading...</h2>
    <div id="answers"></div>
    <p>Time left: <span id="timer">-</span></p>
    <p>Your Score: <span id="score">0</span></p>
    <p id="error" style="color:red;display:none;">Error: failed to load question.</p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getDatabase, ref, onValue, update, set } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

    const app = initializeApp({ databaseURL: "https://pathpharmm-defaultâ€‘rtdb.firebaseio.com/" });
    const db = getDatabase(app);

    const roomCode = new URLSearchParams(location.search).get('room');
    const playerId = localStorage.getItem('playerId');
    const isHost = localStorage.getItem('isHost') === 'true';
    const paths = {
      category: `rooms/${roomCode}/chosenCategory`,
      currentQuestion: `rooms/${roomCode}/currentQuestion`,
      questionStartTime: `rooms/${roomCode}/questionStartTime`,
      quizEnded: `rooms/${roomCode}/quizEnded`,
      playerScore: `rooms/${roomCode}/players/${playerId}`
    };

    let questions = [], index = 0, score = 0, timer = null;

    const qElem = document.getElementById('question');
    const answersDiv = document.getElementById('answers');
    const timerElem = document.getElementById('timer');
    const scoreElem = document.getElementById('score');
    const errorElem = document.getElementById('error');

    const categoryQs = {
      pathology: [
        { q: "What cell type proliferates in acute inflammation?", opts: ["Neutrophil","Lymphocyte","Macrophage","Basophil"], ans: 0},
        { q: "Which organ is most affected by amyloidosis?", opts: ["Liver","Heart","Brain","Lung"], ans: 1 },
        { q: "Which necrosis in MI?", opts: ["Coagulative","Liquefactive","Caseous","Fat"], ans: 0 }
      ],
      pharmacology: [
        { q: "Which is a Î²-blocker?", opts: ["Propranolol","Lisinopril","Losartan","Verapamil"], ans: 0 },
        { q: "Which inhibits ACE?", opts: ["Lisinopril","Losartan","Hydralazine","Propranolol"], ans: 0 },
        { q: "Which is a loop diuretic?", opts: ["Furosemide","HCTZ","Spironolactone","Acetazolamide"], ans: 0 }
      ]
    };

    function shuffle(a){return [...a].sort(()=>Math.random()-0.5);}

    onValue(ref(db, paths.category), snap => {
      const cat = snap.val();
      if (!cat || !categoryQs[cat]) {
        errorElem.textContent = "â›” Invalid category.";
        errorElem.style.display = 'block';
        return;
      }
      questions = shuffle(categoryQs[cat]);
      console.log("Questions loaded:", questions);
    });

    onValue(ref(db, paths.currentQuestion), snap => {
      index = snap.exists() ? snap.val() : 0;
    });

    onValue(ref(db, paths.questionStartTime), snap => {
      if (snap.exists()) startLoop(snap.val());
    });

    onValue(ref(db, paths.quizEnded), snap => {
      if (snap.val()) endQuiz();
    });

    function startLoop(startTs) {
      clearInterval(timer);
      renderQuestion();
      timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTs)/1000);
        const rem = 10 - elapsed;
        timerElem.textContent = rem > 0 ? rem : 0;
        if (rem <= 0) {
          clearInterval(timer);
          disableAnswers();
          if (isHost) nextQuestion();
        }
      }, 200);
    }

    function renderQuestion() {
      const obj = questions[index];
      console.log("Rendering Q#", index, obj);
      if (!obj) {
        errorElem.textContent = "â— Question not found.";
        errorElem.style.display = 'block';
        qElem.textContent = '';
        return;
      }
      errorElem.style.display = 'none';
      qElem.textContent = obj.q;
      answersDiv.innerHTML = '';
      scoreElem.textContent = score;
      obj.opts.forEach((opt,i) => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.onclick = () => answer(i, obj.ans, btn);
        answersDiv.appendChild(btn);
      });
    }

    function disableAnswers(){
      answersDiv.querySelectorAll('button').forEach(b=>b.disabled=true);
    }

    async function answer(chosen, correct, btn) {
      if (answersDiv.querySelector('button:disabled')) return;
      disableAnswers();
      if (chosen === correct) {
        btn.classList.add('correct');
        score += 10;
        scoreElem.textContent = score;
        await update(ref(db, paths.playerScore), { score });
      } else {
        btn.classList.add('incorrect');
        const cs = answersDiv.children[correct];
        if (cs) cs.classList.add('correct');
      }
    }

    async function nextQuestion(){
      const newIndex = index + 1;
      if (newIndex < questions.length) {
        await set(ref(db, paths.currentQuestion), newIndex);
        await set(ref(db, paths.questionStartTime), Date.now());
      } else {
        await set(ref(db, paths.quizEnded), true);
      }
    }

    function endQuiz(){
      clearInterval(timer);
      qElem.textContent = "ðŸŽ‰ Quiz Complete!";
      answersDiv.innerHTML = '';
      timerElem.textContent = '-';
    }
  </script>
</body>
</html>