<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz Room</title>
  <style>
    body {
      background: linear-gradient(to right, #141e30, #243b55);
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding: 30px;
    }

    #answers button {
      display: block;
      margin: 10px auto;
      padding: 12px 20px;
      background: rgba(255,255,255,0.15);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #startBtn {
      background-color: #00ffc3;
      color: #000;
      padding: 14px 24px;
      font-size: 18px;
      margin-top: 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .score {
      margin-top: 20px;
    }

    #status {
      margin-top: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <h1>Multiplayer Quiz</h1>
  <div id="status">Loading room...</div>
  <div id="question-container" style="display:none;">
    <h2 id="question-text"></h2>
    <div id="answers"></div>
    <p>‚è≥ Time left: <span id="time-left">-</span></p>
    <p class="score">Your Score: <span id="score">0</span></p>
  </div>
  <button id="startBtn" style="display:none;">Start Game</button>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getDatabase, ref, set, update, get, onValue, child } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCgRJlAMQVnY5Zu7nkMPmdvS7lc5xMcJz4",
      authDomain: "pathpharmm.firebaseapp.com",
      projectId: "pathpharmm",
      storageBucket: "pathpharmm.appspot.com",
      messagingSenderId: "836525944124",
      appId: "1:836525944124:web:9ab28aa79e9f12aeea8239",
      databaseURL: "https://pathpharmm-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const roomCode = new URLSearchParams(location.search).get('room') || localStorage.getItem('roomCode');
    const roomRef = ref(db, `rooms/${roomCode}`);

    const questionText = document.getElementById('question-text');
    const answersDiv = document.getElementById('answers');
    const scoreEl = document.getElementById('score');
    const timeLeft = document.getElementById('time-left');
    const startBtn = document.getElementById('startBtn');
    const questionContainer = document.getElementById('question-container');
    const statusMsg = document.getElementById('status');

    const questions = [
      {
        question: "Which organ produces insulin?",
        options: ["Liver", "Pancreas", "Heart", "Kidney"],
        correct: 1
      },
      {
        question: "What is the main function of red blood cells?",
        options: ["Fight infection", "Transport oxygen", "Digest food", "Carry fat"],
        correct: 1
      }
    ];

    let score = 0;
    let currentIndex = 0;
    let isHost = false;
    let timer = null;

    // üé≤ Generate or retrieve guest ID
    let playerId = localStorage.getItem('playerId');
    if (!playerId) {
      playerId = 'guest_' + Math.random().toString(36).substr(2, 6).toUpperCase();
      localStorage.setItem('playerId', playerId);
    }

    async function initGame() {
      const playersRef = child(roomRef, 'players');
      const snapshot = await get(playersRef);
      const players = snapshot.exists() ? Object.keys(snapshot.val()) : [];

      isHost = players.length === 0;

      await set(child(playersRef, playerId), { id: playerId, score: 0 });

      if (isHost) {
        statusMsg.textContent = "You're the host. Start the game when ready.";
        startBtn.style.display = 'inline-block';
        startBtn.onclick = () => set(child(roomRef, 'gameStarted'), true);
      } else {
        statusMsg.textContent = "Waiting for host to start the game...";
      }

      onValue(child(roomRef, 'gameStarted'), snap => {
        if (snap.exists() && snap.val() === true) {
          startBtn.style.display = 'none';
          statusMsg.style.display = 'none';
          questionContainer.style.display = 'block';
          startQuestion();
        }
      });
    }

    initGame();

    function startQuestion() {
      const q = questions[currentIndex];
      questionText.textContent = q.question;
      answersDiv.innerHTML = '';
      timeLeft.textContent = 10;

      q.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.onclick = () => answerQuestion(i);
        answersDiv.appendChild(btn);
      });

      let countdown = 10;
      timer = setInterval(() => {
        countdown--;
        timeLeft.textContent = countdown;
        if (countdown === 0) {
          clearInterval(timer);
          nextQuestion();
        }
      }, 1000);
    }

    function answerQuestion(index) {
      clearInterval(timer);
      if (index === questions[currentIndex].correct) {
        score += 10;
        scoreEl.textContent = score;
        update(ref(db, `rooms/${roomCode}/players/${playerId}`), { score });
      }
      nextQuestion();
    }

    function nextQuestion() {
      currentIndex++;
      if (currentIndex < questions.length) {
        startQuestion();
      } else {
        questionText.textContent = "üéâ Quiz Finished!";
        answersDiv.innerHTML = "";
        timeLeft.textContent = "-";
      }
    }
  </script>

</body>
</html>